define(["base","app/commonApp","cookies"],function(e,t){var a=null;var n=null;var i=null;var r=null;var o=null;var l=null;var s={};var c=[];var d=null;var u=null;var p=function(e,n,s){o=s.getParentNode();r=s;if(l!=s.level){a=null}if(d!=s.resourceType){a=null}d=s.resourceType;l=s.level;t.initButtonbar($(".ui-grid-buttonbar"));if(s.level==1){$("#child_menu").hide();$("#resource_menu").hide();$("#parent_menu").show();$(i).each(function(e,n){if(s.id==n.id){if(!a){C(1)}else{t.search(a)}}})}else if(s.level==2){$("#parent_menu").hide();$("#resource_menu").hide();$("#child_menu").show();$(i).each(function(e,n){if(s.id==n.id){if(!a){C(0)}else{t.search(a)}}})}else{$("#child_menu").hide();$("#parent_menu").hide();$("#resource_menu").show();switch(r.resourceType){case"1":$("#resource_table2").hide();$("#resource_table3").hide();$("#resource_table1").show();$("#resource_menu button").removeClass("disabled");$(i).each(function(e,n){if(s.id==n.id){if(!a){C(2)}else{t.search(a)}}});break;case"2":$("#resource_table3").hide();$("#resource_table1").hide();$("#resource_table2").show();$("#resource_menu button").addClass("disabled");$(i).each(function(e,n){if(s.id==n.id){if(!a){C(3)}else{t.search(a)}}});break;case"3":$("#resource_table1").hide();$("#resource_table2").hide();$("#resource_table3").show();$("#resource_menu button").addClass("disabled");$(i).each(function(e,n){if(s.id==n.id){if(!a){C(4)}else{t.search(a)}}});break}}t.search(a)};function f(){$(".input-group-addon").on("click",function(){var e=$(".search-box input").val();h(e)})}function m(e,t,a){if(a.highlight){$("#treebar a[title='"+a.name+"']").css({color:"#0091f6"})}}function b(e,t){if(t.id==0){return false}}var h=function(a){var o=a;if(!a){o=""}e.ajax({url:$.path+"/api/catalog/findResourceCatalogTree?resourceName="+o,type:"get",success:function(o){i=o.data;var l=null;if(i.length>1){l=i[1].id}if(a=="save"){l=r.id}n=e.tree({container:$("#treebar"),setting:{data:{simpleData:{enable:true}},callback:{onClick:p,beforeClick:b,onNodeCreated:m}},data:t.mergeTreeData(o.data,"-1"),selectNodeId:l})},beforeSend:function(){e.loading($("#treebar"))}});e.scroll({container:$("#treeAside"),callback:function(){e.pull({container:$("#treeAside"),target:$("#rightPage")})}})};var g={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/catalog/findCatalogList",type:"get",contentType:"application/json",xhrFields:{withCredentials:true},data:function(e){return t.getParams(e,$("#search-form"))+"&id="+r.id}},columns:[{data:"id",sWidth:"8%"},{data:"name",sWidth:"15%"},{data:"code",sWidth:"15%"},{data:"ename",sWidth:"16%"},{data:"auditorUserName",sWidth:"16%"},{data:"telphone",sWidth:"15%"},{data:"auditorCompany",sWidth:"15%"}],columnDefs:[{render:function(e,t,a,n){return"<input type='checkbox' name='cb' value='"+a.id+"' cid='"+JSON.stringify(a)+"' class='cb'/>"},targets:0}],drawCallback:function(a){e.selectAll($("#cball"),$(".cb"),function(){t.checkByGridButton($(".cb"))});t.selectedTr($("#example"))}};var v={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,ajax:{url:$.path+"/api/resCatalog/getResCatalogListByCatalogId",type:"get",contentType:"application/json",xhrFields:{withCredentials:true},data:function(e){return t.getParams(e,$("#search-form"))+"&id="+r.id}},columns:[{data:"id",sWidth:"8%"},{data:"resName",sWidth:"19%"},{data:"resType",sWidth:"18%"},{data:"equipmentName",sWidth:"19%"},{data:"companyName",sWidth:"19%"},{data:"stateName",sWidth:"18%"}],columnDefs:[{render:function(e,t,a,n){return"<input type='checkbox' name='cb' value='"+a.id+"' cid='"+JSON.stringify(a)+"' class='cb'/>"},targets:0},{render:function(e,t,a,n){return"<a class='catalog_detail' cid='"+a.id+"'>"+e+"</a>"},targets:1},{render:function(e,t,a,n){switch(a.resType){case"1":return"数据库";break;case"2":return"文件";break;case"3":return"API";break}},targets:2}],drawCallback:function(a){e.selectAll($("#cball1"),$(".cb"),function(){t.checkByGridButton($(".cb"))});$(".catalog_detail").click(function(){X(this)})}};var y={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,ajax:{url:$.path+"/api/resource/findResourceContent",type:"get",contentType:"application/json",xhrFields:{withCredentials:true},data:function(e){return t.getParams(e,$("#search-form"))+"&resourceId="+r.id}},columns:[{data:"name",sWidth:"15%"},{data:"ename",sWidth:"17%"},{data:"code",sWidth:"17%"},{data:"type",sWidth:"17%"},{data:"length",sWidth:"17%"},{data:"dataCode",sWidth:"17%"}],columnDefs:[{render:function(e,a,n,i){return t.typeSelect(e)},targets:3},{render:function(e,t,a,n){return e?e:"--"},targets:5}],drawCallback:function(e){}};var k={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,ajax:{url:$.path+"/api/resource/findResourceContent",type:"get",contentType:"application/json",xhrFields:{withCredentials:true},data:function(e){return t.getParams(e,$("#search-form"))+"&resourceId="+r.id}},columns:[{data:"fileName",sWidth:"25%"},{data:"fileType",sWidth:"25%"},{data:"fileSize",sWidth:"25%"},{data:"updateDate",sWidth:"25%"}],columnDefs:[{render:function(e,a,n,i){return t.interceptString(e)},targets:0},{render:function(e,a,n,i){return t.interceptString(e)},targets:3}],drawCallback:function(e){}};var T={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,ajax:{url:$.path+"/api/resource/findResourceContent",type:"get",contentType:"application/json",xhrFields:{withCredentials:true},data:function(e){return t.getParams(e,$("#search-form"))+"&resourceId="+r.id}},columns:[{data:"paramName",sWidth:"20%"},{data:"paramType",sWidth:"20%"},{data:"paramSource",sWidth:"20%"},{data:"notNull",sWidth:"20%"},{data:"desc",sWidth:"20%"}],columnDefs:[{render:function(e,a,n,i){e=e?e:"--";return t.interceptString(e)},targets:0},{render:function(e,a,n,i){var r=t.typeSelect(e);return r?r:"系统参数"},targets:1},{render:function(e,t,a,n){return e=="1"?"输入参数":"输出参数"},targets:2},{render:function(e,t,a,n){switch(e){case"1":return"是";break;case"0":return"否";break;default:return"--";break}},targets:3},{render:function(e,a,n,i){e=e?e:"--";return t.interceptString(e)},targets:4}],drawCallback:function(e){}};var C=function(n){switch(n){case 1:a=e.datatables({container:$("#example"),option:g,filter:t.gridFilter});break;case 0:a=e.datatables({container:$("#example1"),option:v,filter:t.gridFilter});break;case 2:a=e.datatables({container:$("#example2"),option:y,filter:t.gridFilters});break;case 3:a=e.datatables({container:$("#example3"),option:k,filter:t.gridFilters});break;case 4:a=e.datatables({container:$("#example4"),option:T,filter:t.gridFilters});break}};var x=function(){$("#search").on("click",function(){t.search(a)})};var w=function(){$("#reset").on("click",function(){t.reset($("#search-form"),a)})};var _=function(){$(".ui-grid-buttonbar .add").on("click",function(){if($(this).hasClass("disabled")){return}if($(this).attr("key")==1){I()}});$(".ui-grid-buttonbar .delete").on("click",function(){var t=$(this).attr("key");var a=e.getChecks("cb");if($(this).hasClass("disabled")){return}else{switch(t){case"1":D({url:$.path+"/api/catalog/deleteCatalogById",params:a,callback:function(e){if(e.message=="success"){e.message="删除成功";h()}else{e.message=e.message}$("#example input").prop("checked",false)}},1);break;case"2":if(a.length>1){e.requestTip({position:"center"}).error("请选择一条数据！");return false}D({url:$.path+"/api/resCatalog/deleteResourceById?id="+a[0],type:"get",callback:function(e){if(e.message=="success"){e.message="删除成功";h()}else{e.message="删除失败"}}},2);break}}});$(".ui-grid-buttonbar .modify").on("click",function(){if($(this).hasClass("disabled")){return}else{var a=$(this).attr("key");switch(a){case"1":var n=JSON.parse($(".ui-grid .cb:checked").attr("cid"));var i=n.auditorEquipment;var r=t.getCookis().loginUserProfileDTO.currentEquipment.equipmentIdentify;if(i!=r){e.requestTip({position:"center"}).error("没有操作权限！");return false}N();break;case"2":O();break;case"3":R();break;case"4":S();break;case"5":var n=JSON.parse($(".ui-grid .cb:checked").attr("cid"));var i=n.equipment;var r=t.getCookis().loginUserProfileDTO.currentEquipment.equipmentIdentify;if(i!=r){e.requestTip({position:"center"}).error("没有操作权限！");return false}q();break}}});$(".ui-grid-buttonbar #catalog").on("click",function(){if($(this).hasClass("disabled")){return}else{E()}});$(".import").click(function(){if($(this).hasClass("disabled")){return}$("#file").replaceWith('<input type="file" name="file" id="file" style="display: none;"/>');$("#file").trigger("click")});$(".export").click(function(){if($(this).hasClass("disabled")){return}var t=e.getChecks("cb");window.location.href=$.path+"/api/resCatalog/downloadResCatalog?selectId="+r.id+"&action="+l+"&ids="+t});$(".catalogFile").on("change","#file",function(){var t=e.getChecks("cb");e.form.fileUpload({url:$.path+"/api/resCatalog/uploadResCatalog",id:"file",params:{selectId:r.id,action:l,ids:t},success:function(t){switch(t.status){case"1":e.requestTip({position:"center"}).success("附件上传成功！");break;default:e.requestTip({position:"center"}).error("附件上传失败！");break}}})})};var N=function(){$("#button_type").val("1");var a={cid:$(".ui-grid .cb:checked").attr("cid")};var n=e.modal({width:700,height:270,label:"修改",url:"../html/catalogManage/catalogManage_add.html",buttons:[{label:"保存",cls:"btn btn-info",clickEvent:function(){var a=e.form.validate({form:$("#form"),checkAll:true});if(!a){return}var i=e.form.getParams($("#form"));i.resDomainId=r.id;i.auditorEquipmentId=$("#hy").attr("tid");i.id=$(".ui-grid .cb:checked").val();if(i){t.submit({url:$.path+"/api/catalog/updateCatalogInfo",params:i,type:"post",async:false,callback:function(e){if(e.message=="success"){e.message="修改成功"}else{e.message="修改失败"}h()}})}n.hide()}},{label:"重置",cls:"btn btn-warning",clickEvent:function(){t.reset($("#form"))}}],callback:function(){var t=JSON.parse($(".ui-grid .cb:checked").attr("cid"));e.form.init(t,$("#form"));$("#hy").val(t.ename).attr("tid",t.auditorEquipmentId);$.ajax({url:$.path+"/api/catalog/findDomainResByDomainIdEquipmentTree?domainId="+r.id,type:"get",xhrFields:{withCredentials:true},success:function(t){var a=e.form.treeSelect({container:$("#hy"),data:t.data,multi:true,clickEvent:function(e,t,n){if(n.disabled){return false}$("#hy").val(n.name);$("#hy").attr("tid",n.id);a.hide()}})}})}})};var q=function(){var t=JSON.parse($(".ui-grid .cb:checked").attr("cid"));if(t.state==2){e.requestTip({position:"center"}).error("待审核状态不允许修改！");return}e.ajax({url:$.path+"/api/resource/beforeUpdateCheckStatue?resourceId="+t.id,type:"post",success:function(a){if(a.data){e.ajax({url:$.path+"/api/resCatalog/findResourceByID?id="+t.id,type:"get",success:function(e){switch(e.data.resType){case"1":E(t.id,true);break;case"2":P(t.id,true);break;case"3":j(t.id,true);break}}})}else{e.requestTip({position:"center"}).error("请先停掉该服务任务")}}})};var D=function(a,n){var i=JSON.parse($(".ui-grid .cb:checked").attr("cid"));if(l=="1"){if(i.isAuditorCompany==false){e.requestTip({position:"center"}).error("没有操作权限！");return false}}else{var r=i.equipment;var o=JSON.parse($.cookie("dssgUserInfo")).loginUserProfileDTO.currentEquipment.equipmentIdentify;if(r!=o){e.requestTip({position:"center"}).error("没有操作权限！");return false}if(i.state==5){e.requestTip({position:"center"}).error("已发布不能删除！");return false}}var s=a.url;var c=a.type?a.type:"post";var i=a.params?a.params:null;var d=a.callback?a.callback:null;e.confirm({confirmCallback:function(){t.submit({url:s,params:i,type:c,callback:d})}})};var R=function(){var n=JSON.parse($(".ui-grid .cb:checked").attr("cid"));var i=n.equipment;var o=JSON.parse($.cookie("dssgUserInfo")).loginUserProfileDTO.currentEquipment.equipmentIdentify;if(i!=o){e.requestTip({position:"center"}).error("当前设备没有操作权限！");return false}var n=JSON.parse($(".ui-grid .cb:checked").attr("cid"));if(n.state!=1){e.requestTip({position:"center"}).error("资源非提交状态！");return false}var l=[];l.push(n.resName);l.push(n.resCode);l.push(n.resEname);var s=true;$.each(l,function(t,a){e.ajax({url:$.path+"/api/resCatalog/checkResNameOrCode?nameOrCode="+a+"&type="+(t+1)+"&catalogId="+r.id,type:"get",success:function(a){if(a.data>1){switch(t){case 0:e.requestTip({position:"center"}).error("资源名称同名");break;case 1:e.requestTip({position:"center"}).error("资源编码同名");break;case 2:e.requestTip({position:"center"}).error("资源英文名同名")}s=false}}})});if(s){e.confirm({label:"提交",text:"确认是否提交",confirmCallback:function(){t.submit({url:$.path+"/api/resCatalog/referResource",params:n,callback:function(e){if(e.message=="success"){e.message="提交成功"}else{e.message="提交失败"}t.search(a)}})}})}};var S=function(){var n=JSON.parse($(".ui-grid .cb:checked").attr("cid"));var i=n.auditEquipment;var r=JSON.parse($.cookie("dssgUserInfo")).loginUserProfileDTO.currentEquipment.equipmentIdentify;if(i!=r){e.requestTip({position:"center"}).error("提示当前设备没有操作权限！");return false}if(n.state!=2){e.requestTip({position:"center"}).error("资源非待审核状态！");return false}u=e.modal({width:900,height:450,label:"审核",url:"../html/catalogManage/catalogManage_examine_step.html",callback:function(){z();$("#resType").change(function(){u.hide();A()})},buttons:[{label:"上一步",id:"step_back",cls:"btn btn-info back",style:"display:none",clickEvent:function(e){$(".modal-body").mCustomScrollbar("scrollTo","top",{scrollInertia:0});steps.back()}},{label:"下一步",id:"step_forward",cls:"btn btn-info forward",style:"display:none",clickEvent:function(){steps.forward(function(){$(".modal-body").mCustomScrollbar("scrollTo","top",{scrollInertia:0});var t=steps.getStep();switch(t){case 0:var a=e.form.validate({form:$("#form1"),checkAll:true});return a;break;case 1:var a=e.form.validate({form:$("#form2"),checkAll:true});return a;break;case 2:return true;break}})}},{label:"保存",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){var n={};n.result=$("#step_table .state").val();n.reviewDesc=$("#step_table .examine").val();n.resourceId=$(".ui-grid .cb:checked").val();e.ajax({url:$.path+"/api/resCatalog/auditResource",type:"post",params:n,async:false,success:function(n){if(n.success){e.requestTip({position:"center"}).success("审核成功")}t.search(a);u.hide()}})}},{label:"关闭",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){u.hide()}}]})};var I=function(){$("#button_type").val("");if(!r.domainMember){e.requestTip({position:"center"}).error("没有操作权限");return false}var n=e.modal({width:700,height:270,label:"新建",url:"../html/catalogManage/catalogManage_add.html",buttons:[{label:"保存",cls:"btn btn-info",clickEvent:function(){var i=e.form.validate({form:$("#form"),checkAll:true});if(!i){return}var o=e.form.getParams($("#form"));o.resDomainId=r.id;o.auditorEquipmentId=$("#hy").attr("tid");if(o){t.submit({url:$.path+"/api/catalog/saveCatalogInfo",params:o,type:"post",async:false,callback:function(e){if(e.message=="success"){e.message="新增成功"}else{e.message="新增失败"}h();t.search(a)}})}n.hide()}},{label:"重置",cls:"btn btn-warning",clickEvent:function(){t.reset($("#form"))}}],callback:function(){var a=t.getCookis();$("#hy").val(a.loginUserProfileDTO.currentEquipment.name);$("#hy").attr("tid",a.loginUserProfileDTO.currentEquipment.id);$(".modal #auditorUserName").val(a.loginUserProfileDTO.currentEquipment.contacts);$(".modal #telphone").val(a.loginUserProfileDTO.currentEquipment.telphone);$.ajax({url:$.path+"/api/catalog/findDomainResByDomainIdEquipmentTree?domainId="+r.id,type:"get",xhrFields:{withCredentials:true},success:function(t){var a=e.form.treeSelect({container:$("#hy"),data:t.data,multi:true,clickEvent:function(t,n,i){if(i.disabled){return false}$("#hy").val(i.name);$("#hy").attr("tid",i.id);a.hide();e.ajax({url:$.path+"/api/syselocalquipment/findSysEquipmentByIdInfo?id="+i.id,type:"get",success:function(e){$(".modal #auditorUserName").val(e.data.contacts);$(".modal #telphone").val(e.data.telphone)}})}})}})}})};var O=function(){u=e.modal({width:900,height:450,label:"编目",url:"../html/catalogManage/catalogManage_flow_step.html",buttons:[{label:"关闭",cls:"btn btn-info",clickEvent:function(e){u.hide()}}],callback:function(){M()}})};var E=function(n,i){u=e.modal({width:1100,height:500,label:i?"编目修改":"编目",url:"../html/catalogManage/catalogManage_database_step.html",callback:function(){L(n);$("#resType").change(function(){u.hide();A()});if(n){$(".check_id").val(n)}},buttons:[{label:"上一步",id:"step_back",cls:"btn btn-info back",style:"display:none",clickEvent:function(e){steps.back()}},{label:"下一步",id:"step_forward",cls:"btn btn-info forward",style:"display:none",clickEvent:function(){steps.forward(function(){$(".modal-body").mCustomScrollbar("scrollTo","top",{scrollInertia:0});var a=steps.getStep();switch(a){case 0:var n=e.form.validate({form:$("#form1"),checkAll:true});return n;break;case 1:var n=e.form.validate({form:$("#form2"),checkAll:true});if(n){s=$.extend(e.form.getParams($("#form1")),e.form.getParams($("#form2")));s.themeType=$("#themeName").attr("tid");s.industryType=$("#industryTypeName").attr("tid");s.catalogId=r.id}return n;break;case 2:var i=[];var o=true;var l=false;$("#step_table tbody tr").each(function(a,n){var r={};r.name=$(n).find(".name").val();r.ename=$(n).find(".ename").val();r.code=$(n).find(".code").val();r.type=$(n).find(".dataType").val()?$(n).find(".dataType").val():t.typeSelectText($(n).find(".dataType").text());r.length=$(n).find(".dataLength").val()?$(n).find(".dataLength").val():$(n).find(".dataLength").text();if($(n).find(".optData").val()!=0&&$(n).find(".optData").val()!=1){r.dataCode=$(n).find(".optData").val();r.isData=true}else{r.isData=false}if($(n).find(".primary").hasClass("active")){r.pk=true;l=true}else{r.pk=false}if(r.name==undefined||r.name.length==0||r.ename.length==0||r.code.length==0){o=false;e.requestTip({position:"center"}).error("名称或编码不能为空！");return}r.ename="res_"+r.ename;var s=/^\w+$/;if(!s.test(r.ename)){o=false;e.requestTip({position:"center"}).error("英文名称不符合！");return}var s=/^[0-9]*$/;if(r.length!="--"){if(!s.test(r.length)||r.length.length==0){o=false;e.requestTip({position:"center"}).error("数据项长度为数字，且不为空！");return}}else{r.length=""}i.push(r)});s.dbJson=i;Z();H();for(var c=0;c<i.length;c++){for(var d=c+1;d<i.length;d++){if(i[c].name==i[d].name||i[c].ename==i[d].ename||i[c].code==i[d].code){e.requestTip({position:"center"}).error("名称或编码重复，请修改！");o=false;return}}}if(!l&&o){o=false;e.confirm({text:"主键未设置，只提供全量交换，是否继续？",confirmCallback:function(){steps.forward()}})}return o;break}})}},{label:"保存并提交",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){u.hide();var n=$(".check_id").val();if(n){s.id=n;var i=Y(true);if(i){e.ajax({url:$.path+"/api/resCatalog/updateReferResourceCatalog",type:"post",params:s,success:function(e){h("save");t.search(a)}})}}else{var i=Y();if(i){e.ajax({url:$.path+"/api/resCatalog/saveReferResourceCatalog",type:"post",params:s,success:function(e){h("save");t.search(a)}})}}}}]})};var P=function(n){u=e.modal({width:1100,height:500,label:"编目",url:"../html/catalogManage/catalogManage_file_step.html",callback:function(){U();$("#resType").change(function(){u.hide();A()});if(n){$(".check_id").val(n)}},buttons:[{label:"上一步",id:"step_back",cls:"btn btn-info back",style:"display:none",clickEvent:function(e){steps.back()}},{label:"下一步",id:"step_forward",cls:"btn btn-info forward",style:"display:none",clickEvent:function(){steps.forward(function(){$(".modal-body").mCustomScrollbar("scrollTo","top",{scrollInertia:0});var t=steps.getStep();switch(t){case 0:var a=e.form.validate({form:$("#form1"),checkAll:true});return a;break;case 1:var a=e.form.validate({form:$("#form2"),checkAll:true});if(a){s=$.extend(e.form.getParams($("#form1")),e.form.getParams($("#form2")));s.themeType=$("#themeName").attr("tid");s.industryType=$("#industryTypeName").attr("tid");s.catalogId=r.id}Z();return a;break;case 2:return true;break}})}},{label:"保存并提交",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){u.hide();var n=$(".check_id").val();if(n){s.id=n;var i=Y(true);if(i){e.ajax({url:$.path+"/api/resCatalog/updateReferResourceCatalog",type:"post",params:s,success:function(e){h("save");t.search(a)}})}}else{var i=Y();if(i){e.ajax({url:$.path+"/api/resCatalog/saveReferResourceCatalog",type:"post",params:s,success:function(e){h("save");t.search(a)}})}}}}]})};var j=function(n){u=e.modal({width:1100,height:500,label:"编目",url:"../html/catalogManage/catalogManage_api_step.html",callback:function(){B();$("#resType").change(function(){u.hide();A()});if(n){$(".check_id").val(n)}},buttons:[{label:"上一步",id:"step_back",cls:"btn btn-info back",style:"display:none",clickEvent:function(e){steps.back()}},{label:"下一步",id:"step_forward",cls:"btn btn-info forward",style:"display:none",clickEvent:function(){steps.forward(function(){$(".modal-body").mCustomScrollbar("scrollTo","top",{scrollInertia:0});var t=steps.getStep();var a=/^[a-zA-Z]+$/;switch(t){case 0:var n=e.form.validate({form:$("#form1"),checkAll:true});return n;break;case 1:var n=e.form.validate({form:$("#form2"),checkAll:true});if(n){s=$.extend(e.form.getParams($("#form1")),e.form.getParams($("#form2")));s.themeType=$("#themeName").attr("tid");s.industryType=$("#industryTypeName").attr("tid");s.catalogId=r.id}return n;break;case 2:var i=[];var o=true;$("#step_tableIn tbody tr").each(function(t,n){var r={};r.name=$(n).find(".name").val();r.example=$(n).find(".example").val();r.mandatory=$(n).find(".mandatory").val();r.desc=$(n).find(".desc").val();if(!a.test(r.name)){e.requestTip({position:"center"}).error("参数名称为英文，且不为空！");o=false}if(r.name||r.example||r.mandatory||r.desc){i.push(r)}});s.inParameterJson=i;return o;break;case 3:var l=[];var c=true;$("#step_tableOut tbody tr").each(function(t,n){var i={};i.name=$(n).find(".name").val();i.example=$(n).find(".example").val();i.notNull=$(n).find(".notNull").val();i.desc=$(n).find(".desc").val();i.type=$(n).find(".type").val();if(!a.test(i.name)){e.requestTip({position:"center"}).error("参数名称为英文，且不为空！");c=false}if(i.name||i.example||i.notNull||i.desc||i.type){l.push(i)}});if(s.apiType=="local"){if(l.length==0){e.requestTip({position:"center"}).error("本地数据库类型资源，输出参数不能为空！");c=false}}s.outParameterJson=l;Z();Q();return c;break;case 4:return true;break}})}},{label:"保存并提交",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){u.hide();var n=$(".check_id").val();if(n){s.id=n;var i=Y(true);if(i){e.ajax({url:$.path+"/api/resCatalog/updateReferResourceCatalog",type:"post",params:s,success:function(e){h("save");t.search(a)}})}}else{var i=Y();if(i){e.ajax({url:$.path+"/api/resCatalog/saveReferResourceCatalog",type:"post",params:s,success:function(e){h("save");t.search(a)}})}}}}]})};var A=function(){var e=$(".check_id").val();switch($("#resType").val()){case"1":E(e);break;case"2":P(e);break;case"3":j(e);break}};var W=function(a){var n={};n.grid=null;n.count=0;n.gridContainer=$("#step_table");n.gridOption={processing:true,serverSide:false,searching:false,ordering:false,lengthChange:false,bPaginate:false,bInfo:false,drawCallback:function(){n.gridContainer.find("tbody").unbind("click").on("click",".delete",function(){n.grid.deleteRow(this);n.setKeyActive()})}};n.init=function(){n.grid=e.datatables({container:n.gridContainer,option:n.gridOption});n.setAddRow();n.grid.addRow(n.getRowData())};n.setAddRow=function(){$("#addRow").on("click",function(){n.grid.addRow(n.getRowData());n.setKeyActive()})};n.setDeleteRow=function(){n.gridContainer.find("tbody").on("click",".delete",function(){n.grid.deleteRow(this);n.setKeyActive()})};n.getRowData=function(){var e=["<input type='text' name='name"+n.count+"' class='form-control name'/>","<input type='text' name='name"+n.count+"' class='form-control ename'/>","<input type='text' name='name"+n.count+"' class='form-control code'/>","<select class='form-control dataType'><option value='12'>文本</option><option value='91'>日期</option><option value='3'>数字</option><option value='93'>时间</option><option value='4'>整型</option><option value='2004'>大字段</option></select>","<input type='text' name='name"+n.count+"' class='form-control dataLength'/>","<select class='form-control optData'><option value='0'>默认填写</option><option value='1'>选择数据元</option></select>","<div style='text-align:center'><button class='btn btn-link delete' title='删除'><i class='fa fa-trash-o'></i></button><button class='btn btn-link primary key' title='主键'><i class='fa fa-key'></i></button></div>"];n.count++;return e};n.setKeyActive=function(){n.gridContainer.find("tbody").on("click",".primary",function(){$(this).toggleClass("active")})};n.setOptData=function(){$("#step_table").on("change",".optData",function(){var a=this;var i=$(this).parents("tbody").find("tr").index($(this).parents("tr"));var r=$("#step_table tbody tr:eq("+i+") .name").val();var o=$("#step_table tbody tr:eq("+i+") .ename").val();var l=$("#step_table tbody tr:eq("+i+") .code").val();var s=$("#step_table tbody tr:eq("+i+") .dataType").text();var c=$("#step_table tbody tr:eq("+i+") .dataLength").text();if($(this).val()==1){var d=e.modal({width:1100,height:500,id:"checkDataModal",label:"选择数据元",modalOption:{backdrop:"static",keyboard:false},url:"../html/catalogManage/optData.html",buttons:[{label:"确定",cls:"btn btn-info back",clickEvent:function(a){var r=e.getChecks("cbs");if(r.length==0){e.requestTip({position:"center"}).error("请至少选择一条数据！");return false}var o=[];$(".cbs:checked").each(function(){o.push(JSON.parse($(this).attr("cid")))});$.each(o,function(e,a){var r=""+"<td>"+'<input type="text" class="form-control name" value="'+a.name+'"></td>'+"<td>"+'<input type="text" class="form-control ename" value="'+a.englishName+'"></td>'+"<td>"+'<input type="text" class="form-control code" value="'+function(){return a.code1?a.code1:a.code}()+'"></td>'+'<td class="dataType">'+t.typeSelect(a.dataType)+"</td>"+'<td class="dataLength">'+function(){return a.dataLength?a.dataLength:"--"}()+"</td>"+"<td>"+'<select class="form-control optData">'+'<option value="'+a.code+'">'+a.code+"</option>"+'<option value="0">默认填写</option>'+'<option value="1">选择数据元</option></select>'+"</td>"+"<td>"+'<div style="text-align:center">'+'<button class="btn btn-link delete" title="删除">'+'<i class="fa fa-trash-o"></i>'+"</button>"+'<button class="btn btn-link primary key" title="主键">'+'<i class="fa fa-key"></i>'+"</button>"+"</div>"+"</td>";if(e==0){$("#step_table tbody tr:eq("+i+")").empty().append(r);n.setKeyActive()}else{n.grid.addRow(n.getRowData());$("#step_table tbody tr:last").empty().append(r)}});n.setDeleteRow();n.setKeyActive();d.hide()}},{label:"关闭",cls:"btn btn-info back",clickEvent:function(e){$(a).find("option:first").prop("selected","selected");d.hide()}}],callback:function(){$("#checkDataModal .fa-remove").remove()}})}else if($(this).val()==0){var u=""+"<td>"+'<input type="text" class="form-control name" value="'+r+'"></td>'+"<td>"+'<input type="text" class="form-control ename" value="'+o+'"></td>'+"<td>"+'<input type="text" class="form-control code" value="'+l+'"></td>'+'<td><select class="form-control dataType"><option value="91">日期</option><option value="12">文本</option><option value="3">数字</option><option value="93">时间</option><option value="4">整型</option><option value="2004">大字段</option></select></td>'+"<td>"+function(){if(c=="--"){return"<div class='dataLength'>--</div>"}return'<input type="text" class="form-control dataLength" value="'+c+'">'}()+"</td><td>"+'<select class="form-control optData">'+'<option value="0">默认填写</option>'+'<option value="1">选择数据元</option></select>'+"</td>"+"<td>"+'<div style="text-align:center">'+'<button class="btn btn-link delete" title="删除">'+'<i class="fa fa-trash-o"></i>'+"</button>"+'<button class="btn btn-link primary key" title="主键">'+'<i class="fa fa-key"></i>'+"</button>"+"</div>"+"</td>";$("#step_table tbody tr:eq("+i+")").empty().append(u);$("#step_table tbody tr:eq("+i+")").find(".dataType").val(t.typeSelectText(s))}});$("#step_table").on("change",".dataType",function(){var e=this;var t=$(this).val();if(t==12||t==3||t==4){$(e).parents("tr").children("td:eq(4)").html('<input type="text" class="form-control dataLength">')}else{$(e).parents("tr").children("td:eq(4)").html("<div class='dataLength'>--</div>")}})};n.setModify=function(){if(a){e.ajax({url:$.path+"/api/resCatalog/findResourceByID?id="+a,type:"get",success:function(a){var i=a.data;var r=false;delete i.resType;e.form.init(i,$("#form1"));e.form.init(i,$("#form2"));$("#themeName").val(i.themeTypeName);$("#themeName").attr("tid",i.themeType);$("#industryTypeName").val(i.industryTypeName);$("#industryTypeName").attr("tid",i.industryType);var o=i.filePath?i.filePath:i.pictureUrl;$(".ui-page-headingImage").attr("src",$.path1+o);if(i.realFileName){$("#fileName").html(i.realFileName+"<i class='fa fa fa-trash-o fileNameRemove'></i>")}if(i.state==5||i.state==3){var l=["linkman","resType","catalogUnit","phone","apiType","resName","resEname","resCode","resLevel","ui-treeSelect"];t.disableInput(l);r=true}var s=JSON.parse(a.data.dbJson);$.each(s,function(e,a){var i=null;if(a.isData){if(r){i=""+"<td>"+'<input type="text" class="form-control name" value="'+a.name+'" disabled="disabled"></td>'+"<td>"+'<input disabled="disabled" type="text" class="form-control ename" value="'+function(){return a.ename.substring(4)}()+'"></td>'+"<td>"+'<input type="text" class="form-control code" value="'+a.code+'" disabled="disabled"></td>'+'<td class="dataType">'+t.typeSelect(a.type)+"</td>"+'<td class="dataLength">'+function(){return a.length?a.length:"--"}()+"</td>"+"<td>"+'<select class="form-control optData" disabled="disabled">'+'<option value="'+a.code+'">'+a.code+"</option>"+'<option value="0">默认填写</option>'+'<option value="1">选择数据元</option></select>'+"</td>"+"<td>"+'<div style="text-align:center">'+'<button class="btn btn-link delete" title="删除" disabled="disabled">'+'<i class="fa fa-trash-o"></i>'+"</button>"+'<button class="btn btn-link primary key " title="主键" disabled="disabled">'+'<i class="fa fa-key"></i>'+"</button>"+"</div>"+"</td>"}else{i=""+"<td>"+'<input type="text" class="form-control name" value="'+a.name+'"></td>'+"<td>"+'<input type="text" class="form-control ename" value="'+function(){return a.ename.substring(4)}()+'"></td>'+"<td>"+'<input type="text" class="form-control code" value="'+a.code+'"></td>'+'<td class="dataType">'+t.typeSelect(a.type)+"</td>"+'<td class="dataLength">'+function(){return a.length?a.length:"--"}()+"</td>"+"<td>"+'<select class="form-control optData">'+'<option value="'+a.code+'">'+a.code+"</option>"+'<option value="0">默认填写</option>'+'<option value="1">选择数据元</option></select>'+"</td>"+"<td>"+'<div style="text-align:center">'+'<button class="btn btn-link delete" title="删除">'+'<i class="fa fa-trash-o"></i>'+"</button>"+'<button class="btn btn-link primary key " title="主键">'+'<i class="fa fa-key"></i>'+"</button>"+"</div>"+"</td>"}}else{if(r){i=""+"<td>"+'<input type="text" class="form-control name" value="'+a.name+'" disabled="disabled"></td>'+"<td>"+'<input disabled="disabled" type="text" class="form-control ename" value="'+function(){return a.ename.substring(4)}()+'"></td>'+"<td>"+'<input disabled="disabled" type="text" class="form-control code" value="'+a.code+'"></td>'+'<td><select class="form-control dataType" disabled="disabled"><option value="12">文本</option><option value="91">日期</option><option value="3">数字</option><option value="93">时间</option><option value="4">整型</option><option value="2004">大字段</option></select></td>'+"<td>"+function(){if(!a.length){return"<div class='dataLength'>--</div>"}else{return'<input type="text" disabled="disabled" class="form-control dataLength" value="'+a.length+'">'}}()+"</td><td>"+'<select class="form-control optData" disabled="disabled">'+'<option value="0">默认填写</option>'+'<option value="1">选择数据元</option></select>'+"</td>"+"<td>"+'<div style="text-align:center">'+'<button class="btn btn-link delete" title="删除" disabled="disabled">'+'<i class="fa fa-trash-o"></i>'+"</button>"+'<button class="btn btn-link primary key" title="主键" disabled="disabled">'+'<i class="fa fa-key"></i>'+"</button>"+"</div>"+"</td>"}else{i=""+"<td>"+'<input type="text" class="form-control name" value="'+a.name+'"></td>'+"<td>"+'<input type="text" class="form-control ename" value="'+function(){return a.ename.substring(4)}()+'"></td>'+"<td>"+'<input type="text" class="form-control code" value="'+a.code+'"></td>'+'<td><select class="form-control dataType"><option value="12">文本</option><option value="91">日期</option><option value="3">数字</option><option value="93">时间</option><option value="4">整型</option><option value="2004">大字段</option></select></td>'+"<td>"+function(){if(!a.length){return"<div class='dataLength'>--</div>"}else{return'<input type="text" class="form-control dataLength" value="'+a.length+'">'}}()+"</td><td>"+'<select class="form-control optData">'+'<option value="0">默认填写</option>'+'<option value="1">选择数据元</option></select>'+"</td>"+"<td>"+'<div style="text-align:center">'+'<button class="btn btn-link delete" title="删除">'+'<i class="fa fa-trash-o"></i>'+"</button>"+'<button class="btn btn-link primary key" title="主键">'+'<i class="fa fa-key"></i>'+"</button>"+"</div>"+"</td>"}}if(e==0){$("#step_table tbody tr:eq(0)").empty().append(i);$("#step_table tbody tr:last").find(".dataType").val(a.type)}else{n.grid.addRow(n.getRowData());$("#step_table tbody tr:last").empty().append(i);$("#step_table tbody tr:last").find(".dataType").val(a.type);n.setKeyActive()}if(a.pk){$("#step_table tbody tr:last .key").addClass("active")}})}})}};n.init();n.setOptData();n.setKeyActive();n.setModify()};var J=function(){var a=$(".check_id").val();$.ajax({url:$.path+"/api/sysBussinessDictionary/findDictionaryTreeByType",type:"post",data:JSON.stringify({name:"themeType",type:1}),contentType:"application/json",xhrFields:{withCredentials:true},success:function(t){if(!a){$("#themeName").val(t.data[0].name);$("#themeName").attr("tid",t.data[0].id)}e.form.treeSelect({container:$("#themeName"),data:t.data})}});$.ajax({url:$.path+"/api/sysBussinessDictionary/findDictionaryTreeByType",type:"post",data:JSON.stringify({name:"industryType",type:2}),contentType:"application/json",xhrFields:{withCredentials:true},success:function(t){if(!a){$("#industryTypeName").val(t.data[0].name);$("#industryTypeName").attr("tid",t.data[0].id)}e.form.treeSelect({container:$("#industryTypeName"),data:t.data})}});$("#imageBtn").on("click",function(){$("#file1").replaceWith($("#file1").val("").clone(true));$("#file1").trigger("click")});$("#file1").on("change",function(){if($("#fileName").html()){e.requestTip({position:"center"}).error("只能上传一个文件！");return}$("#fileName").html($(this).val()+"<i class='fa fa fa-trash-o fileNameRemove'></i>");var t=e.requestTip({position:"center"});var a=new FormData($("#uploadForm1")[0]);$.ajax({url:$.path+"/api/fileUpload/uploadFile",type:"POST",cache:false,data:a,processData:false,contentType:false,xhrFields:{withCredentials:true},success:function(e){var t=JSON.parse(e).filesObj[0].filePath;$("#attachmentId").val(JSON.parse(e).filesObj[0].fid);if(t){$(".ui-page-headingImage").attr("src",$.path+"/dssg/"+t)}}})});$("#fileName").on("click",".fileNameRemove",function(){$(this).parent().empty();$("#attachmentId").val("")});var n=t.getCookis();$(".linkMan").val(n.loginUserProfileDTO.currentEquipment.contacts);$(".phone").val(n.loginUserProfileDTO.currentEquipment.telphone);$(".identicalName").blur(function(){var t=this;if(!$(t).val().length){return}var a=e.getChecks("cb");var n=a.length==1?1:0;e.ajax({url:$.path+"/api/resCatalog/checkResNameOrCode?nameOrCode="+$(t).val()+"&type="+$(t).attr("data-type")+"&catalogId="+r.id,type:"get",success:function(a){if(a.data>n){switch($(t).attr("data-type")){case"1":e.requestTip({position:"center"}).error("资源名称同名");break;case"2":e.requestTip({position:"center"}).error("资源编码同名");break;case"3":e.requestTip({position:"center"}).error("资源英文名同名")}$(t).focus()}}})})};var F=function(){e.scroll({container:$(".ui-gridbar")})};var L=function(t){steps=e.steps({container:$(".ui-steps"),data:[{label:"编写项目申请",contentToggle:"#content1"},{label:"填写元数据",contentToggle:"#content2",callback:function(){J()}},{label:"编辑数据项",contentToggle:"#content3",callback:function(){W(t)}},{label:"编目预览",contentToggle:"#content4",callback:function(){}}],buttonGroupToggle:u.modalFooter})};var M=function(){var t=0;var a=JSON.parse($(".ui-grid .cb:checked").attr("cid"));switch(a.state){case"1":t=1;break;case"2":t=2;break;default:t=3}steps=e.steps({container:$("#ui-steps"),data:[{label:"资源编目",contentToggle:"#content1"},{label:"提交审核",contentToggle:"#content2",callback:function(){}},{label:"编目审核",contentToggle:"#content3",callback:function(){}},{label:"编目完成",contentToggle:"#content4"}],buttonGroupToggle:u.modalFooter,currentStep:t})};var U=function(){steps=e.steps({container:$(".ui-steps"),data:[{label:"编写项目申请",contentToggle:"#content1"},{label:"填写元数据",contentToggle:"#content2",callback:function(){J()}},{label:"编目预览",contentToggle:"#content3",callback:function(){}}],buttonGroupToggle:u.modalFooter})};var B=function(){steps=e.steps({container:$(".ui-steps"),data:[{label:"填写编目申请",contentToggle:"#content1"},{label:"填写元数据",contentToggle:"#content2",callback:function(){J()}},{label:"输入参数配置",contentToggle:"#content3",callback:function(){K()}},{label:"输出参数配置",contentToggle:"#content4",callback:function(){G()}},{label:"编目预览",contentToggle:"#content5",callback:function(){}}],buttonGroupToggle:u.modalFooter})};var K=function(t){var a={};a.grid=null;a.count=0;a.gridContainer=$("#step_tableIn");a.gridOption={processing:true,serverSide:false,searching:false,ordering:false,lengthChange:false,bPaginate:false,bInfo:false,drawCallback:function(){a.gridContainer.find("tbody .delete").unbind("click").on("click",function(){a.grid.deleteRow(this)})}};a.init=function(){a.grid=e.datatables({container:a.gridContainer,option:a.gridOption});a.setAddRow()};a.setAddRow=function(){$("#addRowIn").on("click",function(){a.grid.addRow(a.getRowData())})};a.setDeleteRow=function(){a.gridContainer.find("tbody").on("click",".delete",function(){a.grid.deleteRow(this)})};a.getRowData=function(){var e=["<input type='text' class='form-control name' placeholder='请输入...'/>","系统参数","<select class='form-control mandatory'><option value='1'>是</option><option value='0'>否</option></select>","<input type='text' class='form-control example' placeholder='请输入...'>","<input type='text' class='form-control desc' placeholder='请输入...'/>","<div style='text-align:center'><button class='btn btn-link delete' title='删除'><i class='fa fa-trash-o'></i></button></div>"];return e};a.init()};var G=function(t){var a={};a.grid=null;a.count=0;a.gridContainer=$("#step_tableOut");a.gridOption={processing:true,serverSide:false,searching:false,ordering:false,lengthChange:false,bPaginate:false,bInfo:false,drawCallback:function(){a.gridContainer.find("tbody .delete").unbind("click").on("click",function(){a.grid.deleteRow(this)})}};a.init=function(){a.grid=e.datatables({container:a.gridContainer,option:a.gridOption});a.setAddRow()};a.setAddRow=function(){$("#addRowOut").on("click",function(){a.grid.addRow(a.getRowData())})};a.setDeleteRow=function(){a.gridContainer.find("tbody").on("click",".delete",function(){a.grid.deleteRow(this)})};a.getRowData=function(){var e=["<input type='text' class='form-control name' placeholder='请输入...'/>","<select class='form-control type'><option value='91'>日期</option><option value='12'>文本</option><option value='3'>数字</option><option value='93'>时间</option><option value='4'>整型</option><option value='2004'>大字段</option></select>","<select class='form-control notNull'><option value='1'>是</option><option value='0'>否</option></select>","<input type='text' class='form-control example' placeholder='请输入...'>","<input type='text' class='form-control desc' placeholder='请输入...'/>","<div style='text-align:center'><button class='btn btn-link delete' title='删除'><i class='fa fa-trash-o'></i></button></div>"];return e};a.init()};var z=function(){steps=e.steps({container:$(".ui-steps"),data:[{label:"查看编目申请",contentToggle:"#content1"},{label:"查看元数据信息",contentToggle:"#content2",callback:function(){}},{label:"填写审批意见",contentToggle:"#content3",callback:function(){}}],buttonGroupToggle:u.modalFooter})};var Z=function(){$(".resType").text(V(s.resType));$(".resName").text(s.resName);$(".abstracts").text(s.abstracts);$(".resCode").text(s.resCode);$(".resEname").text(s.resEname);$(".resLevel").text(s.resLevel==1?"部分共享":"完全共享");$(".themeTypeName").text(s.themeName);$(".industryTypeName").text(s.industryTypeName);$(".catalogName").text(o.name);$(".updateCycle").text(s.updateCycle);if(!$("#fileName").html()){e.ajax({url:$.path+"/api/sysBussinessDictionary/getPicturePath?id="+s.themeType,type:"get",success:function(e){$(".ui-page-headingImage").attr("src",$.path1+e.data)}})}};var H=function(){$(".db-tbody").empty();$.each(s.dbJson,function(e,a){var n="<tr><td>"+a.name+"</td>"+"<td>"+a.ename.substring(4)+"</td>"+"<td>"+a.code+"</td>"+"<td>"+t.typeSelect(a.type)+"</td>"+"<td>"+function(){return a.length?a.length:"--"}()+"</td>"+"<td>"+function(){return a.dataCode?a.dataCode:"--"}()+"</td></tr>";$(".db-tbody").append(n)})};var Q=function(){$(".in-tbody").empty();$.each(s.inParameterJson,function(e,t){var a="<tr><td>"+t.name+"</td>"+"<td>系统参数</td>"+"<td>"+function(){return t.mandatory=="1"?"是":"否"}()+"</td>"+"<td>"+t.desc+"</td></tr>";$(".in-tbody").append(a)});$(".out-tbody").empty();$.each(s.outParameterJson,function(e,a){var n="<tr><td>"+a.name+"</td>"+"<td>"+t.typeSelect(a.type)+"</td>"+"<td>"+function(){return a.notNull=="1"?"是":"否"}()+"</td>"+"<td>"+a.desc+"</td></tr>";$(".out-tbody").append(n)})};var V=function(e){switch(e){case"1":return"数据库";break;case"2":return"文件";break;case"3":return"API";break}};var X=function(t){var a=e.modal({width:900,height:450,label:"详情",url:"../html/catalogManage/catalog_detail.html",buttons:[{label:"关闭",cls:"btn btn-info",clickEvent:function(){a.hide()}}],callback:function(){var e=$(t).attr("cid");$("#catalog_detail").val(e)}})};var Y=function(t){debugger;var a=[];var n=null;a.push(s.resName);a.push(s.resCode);a.push(s.resEname);var i=t?1:0;$.each(a,function(t,a){e.ajax({url:$.path+"/api/resCatalog/checkResNameOrCode?nameOrCode="+a+"&type="+(t+1)+"&catalogId="+r.id,type:"get",async:false,success:function(a){if(a.data>i){switch(t){case 0:e.requestTip({position:"center"}).error("资源名称同名");break;case 1:e.requestTip({position:"center"}).error("资源编码同名");break;case 2:e.requestTip({position:"center"}).error("资源英文名同名")}}else{n=true}}})});return n};return{main:function(){a=null;F();h();_();x();w();f()}}});