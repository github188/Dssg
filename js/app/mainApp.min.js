define(["base","app/commonApp","fileinput","fileinputZh"],function(e,a){var t=null;var n=null;var i=null;var o=false;var l=null;var c=function(i){var o=function(e,a,t){if(e==false){return"none"}else{return"block"}};var l=a.getCookis();if(!l){window.location.href=$.path+"/dssg-portal/login.html"}var c=l.loginUserProfileDTO.id;e.ajax({url:$.path+"/api/sysmenus/findMenus?userId="+c,type:"get",xhrFields:{withCredentials:true},success:function(a,l,c){var s=a.data;n=e.arrayToMap(s,"-1",false);scopeMenuData=n;t=e.mapToArray(n,"-1");var f="首页",p=0,m="ba751acb621e11e79e16662db0eb88e8";if($.cookie("messageurl")&&$.cookie("messageurl")=="all"){i="xx1cbe16621e11e79e16662db0eb88e8";$.cookie("messageurl",null,{path:"/"})}else if($.cookie("messageurl")&&$.cookie("messageurl")!="all"&&$.cookie("messageurl")!="null"){i=$.cookie("messageurl");$.cookie("messageurl",null,{path:"/"})}if(i){$.each(t,function(e,a){$.each(a.items,function(e,t){if(i==t.id){a.active=true;a.items[e].active=true}})});m=i}else{if(m=="ba751acb621e11e79e16662db0eb88e8"){}else{$.each(t,function(e,a){if(a.label==f){a.active=true;a.items[p].active=true}})}}e.template({container:$(".ui-menu"),templateId:"menu-tpl",data:t,helper:[{name:"show",event:o}],callback:function(){e.scroll({container:$(".ui-menubar")});$("#menubar .panel-collapse").on("hide.bs.collapse",function(e){$(e.target).parent().find(".panel-title a i:eq(1)").attr("class","fa fa-angle-down")});$("#menubar .panel-collapse").on("show.bs.collapse",function(e){$(e.target).parent().find(".panel-title a i:eq(1)").attr("class","fa fa-angle-up")});$("#menubar .panel-body li").on("click",function(){$("#menubar .panel-body li").removeClass("active");$("#menubar .panel:first").css({background:"transparent",color:"#fff"});$(this).addClass("active");r($(this).attr("mid"))});$("#menubar .panel:first").bind("click","a",function(){$(this).css({background:"#013c58",color:"#04ccff"});$("#menubar .panel .panel-collapse").removeClass("in");$("#menubar .panel .panel-collapse li").removeClass("active");r("ba751acb621e11e79e16662db0eb88e8")});r(m);u()}})},beforeSend:function(e){a.getUserSession(e)}});e.ajax({url:$.path+"/api/home/systemMessages?page=0&size=5",type:"get",success:function(a){if(a.data==null){$(".messageNumber span").text("消息(0)");return}var t="";$.each(a.data.content,function(e,a){switch(a.type){case"2":a.mes="系统消息";break;case"3":a.mes="告警信息";break;case"4":a.mes="待办消息";break}});$(".messageNumber span").text("消息("+a.data.numberOfElements+")");e.template({container:$(".messageMenu"),templateId:"message-tpl",data:a.data,helper:[{name:"show",event:o}],callback:function(){}})}})};var r=function(t){e.ajax({url:$.path+"/api/syscenterequipment/checkSetUpInfo",type:"get",async:false,success:function(e){if(e.code==403){window.location.href=$.path+"/dssg-portal/login.html"}i=e.data.compay}});if(chartInterval){window.clearInterval(chartInterval)}if(chartInterval2){window.clearInterval(chartInterval2)}var o=n[t]?n[t]:null;var l=a.getCookis();if(l.loginUserProfileDTO.loginState==1){P()}else{if(l.loginUserProfileDTO.settingWindowEnable){if(!l.loginUserProfileDTO.equimentDssgEnable){if(l.loginUserProfileDTO.centerDssgEnable){b()}else{x()}}}}if(o){e.loadPage({container:$(".ui-article"),url:o.url?o.url:"",callback:function(){a.setLocation(scopeMenuData,o.id);$("input").attr("autocomplete","off")}})}};var s=function(){var a={};a.search=function(){e.ajax({url:"",success:function(){}})};a.setSearch=function(){$("#searchInput").on("keydown",function(e){if(e.keyCode==13){if($(this).val()!=""){a.search()}}});$("#searchIcon").on("click",function(){a.search()})};a.setSearch()};function u(){$(".messageMenu li").off().on("click",function(){var e=$(this).attr("mid");if(!e){e="xx1cbe16621e11e79e16662db0eb88e8"}c(e)})}function f(){$(".authorization").off().on("click",function(){$(".authorization-msg").hide();var a="<form enctype='multipart/form-data'>"+"<input id='file-0d' class='file' type='file' multiple='multiple' name='file'>"+"</form>";var t=$("#appraisePage").val();var n="../html/authorization.html";if(t){n="../../html/authorization.html"}var i=e.modal({width:950,height:510,label:"关于授权",url:n,drag:true,callback:function(){if(t){$(".link").attr("href","../../css/fileinput.css");$("#authorImg").attr("src","../../images/un_authorization.jpg")}$(".upload-file").html(a);m();h(i);p()}})})}function p(){var e=$("#appraisePage").val();var a="../images/authorization.jpg";if(e){a="../../images/authorization.jpg"}$.ajax({type:"get",url:$.path+"/api/sysAuth/isExpire",xhrFields:{withCredentials:true},success:function(e){if(!e.data){d();$(".img-box img").attr("src",a);$(".authorization-msg").show()}}})}function m(){$(".load").off().on("click",function(){window.location.href=$.path+"/api/sysAuth/downloadPower"})}function d(){$.ajax({type:"get",url:$.path+"/api/sysAuth/getSysAuthInfo",xhrFields:{withCredentials:true},success:function(e){$.each(e.data,function(e,a){$("."+e).html(a)})}})}function h(a){var t=$("#appraisePage").val();var n="../images/authorization.jpg";if(t){n="../../images/authorization.jpg"}$("#file-0d").fileinput({language:"zh",showUpload:true,browseIcon:"",removeIcon:"",uploadIcon:"",showPreview:true,dropZoneEnabled:false,showPreview:false,cancelIcon:"",uploadUrl:$.path+"/api/sysAuth/uploadPowerFile"}).on("fileuploaded",function(t,i,o,l){if(i.response.data){d();$(".img-box img").attr("src",n);$(".authorization-msg").show();a.hide();e.requestTip({position:"center"}).success("授权成功！")}})}var b=function(){modal=e.modal({width:900,height:450,label:"设备首次设置",modalOption:{backdrop:"static",keyboard:false},url:"../html/centerInitialSetting.html",buttons:[{label:"上一步",id:"step_back",cls:"btn btn-info back",style:"display:none",clickEvent:function(e){steps.back();var a=steps.getStep();if(a==0){$(".modal-footer .cancel").show()}}},{label:"下一步",id:"step_forward",cls:"btn btn-info forward",style:"display:none",clickEvent:function(){steps.forward(function(){$(".modal-body").mCustomScrollbar("scrollTo","top",{scrollInertia:0});var a=steps.getStep();switch(a){case 0:if(!i){e.requestTip({position:"center"}).error("请先设置单位")}else{$(".modal-footer .cancel").hide()}return i;break;case 1:var t=$("#agree_clause").prop("checked");if(!t){e.requestTip({position:"center"}).error("请同意此协议！")}return t;break;case 2:if(!e.form.validate({form:$("#form"),checkAll:true})){return false}var n=null;var o=e.form.getParams($("#form"));o.companyId=$("#hy").attr("tid");e.ajax({url:$.path+"/api/syscenterequipment/createCerInfo",params:o,type:"post",async:false,success:function(e){n=e.success}});if(n){$(".back").remove();w()}return n;break}})}},{label:"下载证书",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){window.location.href=$.path+"/api/syscenterequipment/downCerFile"}},{label:"完成",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){modal.hide()}},{label:"取消",cls:"btn btn-default cancel",clickEvent:function(){e.confirm({label:"提示",text:"取消将退出系统，是否确认？",confirmCallback:function(){window.location.href=$.path+"/dssg-portal/login.html"}})}}],callback:function(){g();$(".modal-header .fa-remove").remove()}})};var g=function(){steps=e.steps({container:$(".ui-steps"),data:[{label:"初始设置引导",contentToggle:"#content1",callback:function(){v()}},{label:"注册协议",contentToggle:"#content2",callback:function(){}},{label:"设置设备信息",contentToggle:"#content3",callback:function(){k()}},{label:"下载设备证书",contentToggle:"#content4",callback:function(){}}],buttonGroupToggle:modal.modalFooter})};function v(){if(i){$(".res-check-common .isCompany").html("已设置")}else{$(".res-check-common .isCompany").html("<a href='#' id='setCompay'>未设置</a>")}}var y=function(){$(document).on("click","#setCompay",function(){modal.hide();e.loadPage({container:$(".ui-article"),url:"../html/cdmaEvdoManage/unitManage.html"})})};var k=function(){e.ajax({url:$.path+"/api/rescentercompany/findCenterCompanyTree",type:"get",success:function(a){var t=e.form.treeSelect({container:$("#hy"),data:a.data,multi:true,clickEvent:function(e,a,n){if(n.disabled){return false}$("#hy").val(n.name);$("#hy").attr("tid",n.id);t.hide()}})}})};function w(){var t=a.getCookis();t.loginUserProfileDTO.equimentDssgEnable=true;$.cookie("dssgUserInfo",JSON.stringify(t));e.ajax({url:$.path+"/api/syscenterequipment/getLocalEquimentInfo",type:"get",success:function(a){var t=a.data;if(t.centerFlag==1){t.centerFlag="管理节点"}else{t.centerFlag="接入节点"}if(!t.company){t.company="--"}e.form.init(t,$("#form1"))}})}function x(){modal=e.modal({width:900,height:450,label:"设备首次设置",modalOption:{backdrop:"static",keyboard:false},url:"../html/nodeInitialSetting.html",buttons:[{label:"上一步",id:"step_back",cls:"btn btn-info back",style:"display:none",clickEvent:function(e){steps.back();var a=steps.getStep();if(a==0){$(".modal-footer .cancel").show()}}},{label:"下一步",id:"step_forward",cls:"btn btn-info forward",style:"display:none",clickEvent:function(){steps.forward(function(){$(".modal-body").mCustomScrollbar("scrollTo","top",{scrollInertia:0});var a=steps.getStep();switch(a){case 0:var t=$("#agree_clause").prop("checked");if(!t){e.requestTip({position:"center"}).error("请同意此协议！")}else{$(".modal-footer .cancel").hide()}return t;break;case 1:if(!o){e.requestTip({position:"center"}).error("请先上传证书!")}e.ajax({url:$.path+"/api/syselocalquipment/authCenterEquipement",type:"post",params:l,success:function(e){}});return o;break;case 2:if(!e.form.validate({form:$("#form3"),checkAll:true})){return false}var n=null;var i=e.form.getParams($("#form3"));e.ajax({url:$.path+"/api/syselocalquipment/createLocalCerInfo",params:i,type:"post",async:false,success:function(e){n=e.success}});if(n){$(".back").remove();w()}return n;break}})}},{label:"下载证书",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){var e=$(".publicIp").text();window.location.href=$.path+"/api/syselocalquipment/downCerFile?publicIp="+e}},{label:"完成",id:"step_confirm",cls:"btn btn-info confirm",style:"display:none",clickEvent:function(){modal.hide()}},{label:"取消",cls:"btn btn-default cancel",clickEvent:function(){e.confirm({label:"提示",text:"取消将退出系统，是否确认？",confirmCallback:function(){window.location.href=$.path+"/dssg-portal/login.html"}})}}],callback:function(){T();$(".modal-header .fa-remove").remove()}})}function T(){steps=e.steps({container:$(".ui-steps"),data:[{label:"注册协议",contentToggle:"#content1"},{label:"认证管理节点证书",contentToggle:"#content2",callback:function(){C()}},{label:"设置设备信息",contentToggle:"#content3",callback:function(){}},{label:"下载设备证书",contentToggle:"#content4",callback:function(){}}],buttonGroupToggle:modal.modalFooter})}function C(){$(".leading-in").click(function(){if($("#ertificate_name div").text()){e.requestTip({position:"center"}).error("不要重复上传！");return false}$("#certificateFile #myFile").trigger("click")});$("#certificateFile").on("change","#myFile",function(){var a=$("#certificateFile #myFile").val();a=a.split("\\");$("#ertificate_name").html("<div>"+a.splice(-1)+"<i class='fa fa-trash' style='cursor:pointer'></i></div>");var t=new FormData($("#certificateFile")[0]);$.ajax({url:$.path+"/api/syselocalquipment/getCenterEquimentCerInfo",type:"POST",cache:false,data:t,processData:false,contentType:false,xhrFields:{withCredentials:true},success:function(a){if(a.success){l=a.data.res;o=true;$("#form").show();e.form.init(a.data.res,$("#form"))}}})});$("#ertificate_name").on("click",".fa-trash",function(){var a=this;e.ajax({url:$.path+"/api/syselocalquipment/deleteAuthFile?filename="+$("#ertificate_name div").text(),type:"get",success:function(e){if(e.success){$(a).parent().remove();o=false;$("#certificateFile #myFile").replaceWith('<input type="file" name="file" id="myFile" style="display: none;"/>');$("#form").hide()}}})})}var I=function(){var t=a.getCookis();var n=$("#appraisePage").val();var i="../login.html";if(n){i="../../login.html"}$("#loginMan").text(t.loginUserProfileDTO.roles.name);$("#logOut").on("click",function(){e.ajax({url:$.path+"/api/login/logout",type:"post",success:function(e){if(e.success){window.location.href=$.path+"/dssg-portal/login.html"}}})})};function P(){var a=e.modal({width:700,height:270,label:"修改密码",modalOption:{backdrop:"static",keyboard:false},url:"../html/modifyPass.html",buttons:[{label:"确定",cls:"btn btn-info",clickEvent:function(){var a=e.form.validate({form:$("#form"),checkAll:true});var t=e.form.getParams($("#form"));if(t.newPassword!=t.newPasswords){e.requestTip({position:"center"}).error("两次密码不统一！");return}e.ajax({url:$.path+"/api/sysuser/updatePassword?newPassword="+t.newPassword,type:"get",success:function(e){window.location.href=$.path+"/dssg-portal/login.html"}})}}],callback:function(){$(".modal-header .close").remove()}})}return{main:function(){$(".portal a").attr("href",$.path+"/dssg-portal/index.html");c();f();y();I()},loadPage:function(e){r(e)}}});