define(["base","app/commonApp","echarts"],function(e,a,t){var i=["#04a0fa","#fa7e04"];var r=["#fa4f04","#5edb02","#02d2b2","#6b03e1"];var s=null;var n={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/subscribeanalysis/findSubscribeResAnalysePage",type:"get",xhrFields:{withCredentials:true},contentType:"application/json",data:function(t){a.gridPageFliter(t);var i=e.form.getParams($("#search-form"));if(!i.equipment)i.equipment="0";if(!i.resourceId)i.resourceId="0";if(i.startTime){i.endTime=i.startTime.slice(13);i.startTime=i.startTime.slice(0,10)}var r;if(i){r=$.extend({resType:"1",page:t.page,size:t.size},i)}return r}},columns:[{data:"startTime",sWidth:"25%"},{data:"loadFlowTotal",sWidth:"25%"},{data:"loadRecordTotal",sWidth:"25%"},{data:"taskTotal",sWidth:"25%"}],drawCallback:function(e){a.selectedTr($("#example1"))}};var l={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/subscribeanalysis/findSubscribeResAnalysePage",type:"get",xhrFields:{withCredentials:true},contentType:"application/json",data:function(t){a.gridPageFliter(t);var i=e.form.getParams($("#search-form"));if(!i.equipment)i.equipment="0";if(!i.resourceId)i.resourceId="0";if(i.startTime){i.endTime=i.startTime.slice(13);i.startTime=i.startTime.slice(0,10)}var r;if(i){r=$.extend({resType:"2",page:t.page,size:t.size},i)}return r}},columns:[{data:"startTime",sWidth:"25%"},{data:"loadFlowTotal",sWidth:"25%"},{data:"loadRecordTotal",sWidth:"25%"},{data:"taskTotal",sWidth:"25%"}],drawCallback:function(e){a.selectedTr($("#example2"))}};var o={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/subscribeanalysis/findSubscribeResAnalysePage",type:"get",xhrFields:{withCredentials:true},contentType:"application/json",data:function(t){a.gridPageFliter(t);var i=e.form.getParams($("#search-form"));if(!i.equipment)i.equipment="0";if(!i.resourceId)i.resourceId="0";if(i.startTime){i.endTime=i.startTime.slice(13);i.startTime=i.startTime.slice(0,10)}var r;if(i){r=$.extend({resType:"3",page:t.page,size:t.size},i)}return r}},columns:[{data:"startTime",sWidth:"33.3%"},{data:"subApiTotal",sWidth:"33.3%"},{data:"loadRecordTotal",sWidth:"33.3%"}],drawCallback:function(e){a.selectedTr($("#example3"))}};var d=function(t){if(!t||t=="1"){s=e.datatables({container:$("#example1"),option:n,filter:a.gridFilter})}else if(t=="2"){s=e.datatables({container:$("#example2"),option:l,filter:a.gridFilter})}else if(t=="3"){s=e.datatables({container:$("#example3"),option:o,filter:a.gridFilter})}};var c={color:i,legend:{left:"center",data:[]},tooltip:{trigger:"axis",axisPointer:{animation:false}},grid:{top:"20%",left:"5%",right:"5%",bottom:"10%",containLabel:true},xAxis:{type:"category",data:[],boundaryGap:true},yAxis:{type:"value",boundaryGap:[0,0],splitLine:{show:true,lineStyle:{color:"#c0c0c0"}}},series:[{name:"流入",type:"line",hoverAnimation:false,smooth:true,areaStyle:{normal:{color:"#20a8d8",opacity:"0.2"}},data:[]}]};var u={color:["#2fb6e6","#faba3c","#67c2ef","#ff8e8e","#00acee"],tooltip:{trigger:"item",formatter:function(e){if(e.data.names.length>25){var a=[];for(var t=0;t<e.data.names.length;t++){if(t>=25&&t%25==0){a.push(e.data.names[t]+"<br />")}else{a.push(e.data.names[t])}}var i=a.join("");return e.seriesName+"<br />"+i+" ("+e.percent+"%)"}else{return e.seriesName+"<br />"+e.data.names+" ("+e.percent+"%)"}}},legend:{orient:"vertical",top:"middle",right:"18%",itemWidth:15,itemHeight:15,data:[]},series:[{name:"订阅资源",type:"pie",radius:["50%","70%"],avoidLabelOverlap:false,hoverAnimation:false,label:{normal:{show:true,position:"center",formatter:function(e,a,t,i){return e.seriesName}}},labelLine:{normal:{show:false}},center:["30%","50%"],data:[]}]};var p=function(a,i,r){var s={};s.chart=null;var n=e.form.getParams($("#search-form"));if(!n.equipment)n.equipment="0";if(!n.resourceId)n.resourceId="0";if(n.startTime){n.endTime=n.startTime.slice(13);n.startTime=n.startTime.slice(0,10)}var l=$.extend({lineChartType:r?r:"1",resType:a?a:"1"},n);s.draw=function(a){e.ajax({url:$.path+"/api/subscribeanalysis/findLineChartDeta",type:"post",params:l,success:function(a){if(a&&a.data){var a=a.data;if(JSON.stringify(a)=="{}"){a=[{xvalue:"",yvalue:""}]}var r=[],n=[];a.forEach(function(e,a){r.push(e.xvalue);n.push(e.yvalue)});if(r.length==1){c.series[0].symbolSize=10}else{c.series[0].symbolSize=0}c.yAxis.min=0;c.yAxis.minInterval=1;c.yAxis.axisLabel={textStyle:{color:"#666"},formatter:function(e,a){return parseInt(e)}};c.xAxis.data=r;c.series[0].data=n;c.series[0].name=i?i:"加载流量";s.chart=e.echarts({container:$("#chart1"),echarts:t,chartOption:c})}}})};s.draw(true)};var m=function(a,i){var r={};r.chart=null;var s=e.form.getParams($("#search-form"));if(s.startTime){s.endTime=s.startTime.slice(13);s.startTime=s.startTime.slice(0,10)}r.params={startTime:s.endTime,resType:a?a:"1"};r.draw=function(a){e.ajax({url:$.path+"/api/subscribeanalysis/findSubLoadFlowTop",type:"post",params:r.params,success:function(a){var a=a.data;if(JSON.stringify(a)=="{}"){a={"暂无订阅设备":0}}var i=[],s=[];for(var n in a){if(n&&n.indexOf("暂无")>-1){i.push(n);s.push({itemStyle:{normal:{color:"#d8d8d8"}},value:parseFloat(a[n]),name:n,names:n});u.color=["#d8d8d8"]}else{var l=n.slice(0,10);i.push(l);s.push({value:parseFloat(a[n]),name:l,names:n})}}u.legend.data=i;u.series[0].data=s;r.chart=e.echarts({container:$("#chart2"),chartOption:u,echarts:t})}})};r.draw()};var f=function(){e.form.date({element:$("#startTime"),range:true,dateOption:{max:-1}});$("#startTime").val(e.getDateByDay(-61,false)+" ~ "+e.getDateByDay(-1,false))};var h=function(a,t){var i={resType:a?a:"1"};if(t){i=$.extend(i,{appId:t})}e.ajax({type:"post",url:$.path+"/api/subscribeanalysis/findSubResName",params:i,success:function(a){e.template({container:$(".sourceName"),templateId:"sourceName-tpl",data:a.data})}})};var v=function(a,t){var i={resType:a?a:"1",resourceId:t?t:"0"};e.ajax({type:"post",url:$.path+"/api/subscribeanalysis/findAppName",params:i,success:function(a){e.template({container:$(".applyName"),templateId:"applyName-tpl",data:a.data})}})};var y=function(e,a){var t=[{key:"loadRecordTotal",label:"加载记录数",type:"0",value:"1"},{key:"loadFlowTotal",label:"加载流量",type:"0",value:"2"},{key:"taskTotal",label:"任务执行次数",type:"0",value:"3"},{key:"subApiTotal",label:"订阅API数",type:"0",value:"4"},{key:"appNum",label:"订阅应用数",type:"0",value:""}];if(e=="loadRecordTotal"){if(a=="1")return{name:"加载记录数",value:"1"};if(a=="2")return{name:"加载文件数",value:"1"};if(a=="3")return{name:"调用次数",value:"1"}}for(var i=0;i<t.length;i++){if(t[i].key==e){return{name:t[i].label,value:t[i].value}}}};var g=function(a){var a=a?a:"1";var t=e.form.getParams($("#search-form"));if(!t.equipment)t.equipment="0";if(!t.resourceId)t.resourceId="0";if(t.startTime){t.endTime=t.startTime.slice(13);t.startTime=t.startTime.slice(0,10)}var i=$.extend({resType:a},t);e.ajax({type:"post",url:$.path+"/api/subscribeanalysis/findSubLoadFlow",params:i,contentType:"application/json",success:function(e){var e=e.data,t="",i="";$("#lineList").empty();for(var r in e){if(e[r]){var s=y(r,a);if(s.name!="订阅设备数"&&s.name!="订阅应用数"){i+="<option value='"+s.value+"'>"+s.name+"</option>"}var n=100/3+"%";var l=a==1?'style="padding:0"':"";t+='<div style="width:'+n+'">'+'<div class="col-md-2"'+l+'><i class="fa fa-upload"></i></div>'+'<div class="col-md-10" style="padding:0">'+"<div>"+s.name+"</div>"+'<div class="num" style="font-size:22px;line-height:22px;">'+e[r]+"</div>"+"</div>"+"</div>"}}$("#lineList").append(i);$(".counter").html(t)}})};var T=function(){$("#search").on("click",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");a.search(s);p(e);m(e);g(e)})};var b=function(){var a=e.form.getParams($("#search-form"));if(!a.resourceId)a.resourceId="0";if(!a.equipment)a.equipment="0";if(a.startTime){a.endTime=a.startTime.slice(13);a.startTime=a.startTime.slice(0,10)}var t=$.extend(a,{resType:1,model:1});var i="";for(var r in t){i+=r+"="+t[r]+"&"}var s=i.substring(0,i.length-1);window.location.href=$.path+"/api/commonController/downloadAnalysis?"+s};function x(){e.scroll({container:$(".scrollWrapper")})}var w=function(){$(".ui-grid-buttonbar .import").on("click",function(){b()});$("#search-form .sourceName").on("change",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");if(e=="3"){var a=$(this).val();v(e,a)}});$("#search-form .applyName").on("change",function(){var e=$(this).val();var a=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");h(a,e)});$(".ui-grid-buttonbar .ui-grid-linkGroup li").on("click",function(){var e=$(this).attr("key");if(e=="1"){$("#fileContent").hide();$("#apiContent").hide();$("#dataContent").show();$(".onlyAPIshow").hide()}else if(e=="2"){$("#dataContent").hide();$("#apiContent").hide();$("#fileContent").show();$(".onlyAPIshow").hide()}else if(e=="3"){$("#dataContent").hide();$("#fileContent").hide();$("#apiContent").show();$(".onlyAPIshow").show()}h(e);g(e);p(e);m(e);d(e)});$("#lineList").on("change",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");var a=$(this).val();var t=$(this).find("option:selected").text();p(e,t,a)})};var k=function(){$(".statisticalDate .showDate").html(": "+e.getDateByDay(-1,false))};return{main:function(){x();f();h();v();g();p();m();a.setPanelButtonbar();a.setGridLinkGroup();w();d();T();k()}}});