define(["base","app/commonApp","echarts"],function(e,a,t){var i=["#04a0fa","#fa7e04"];var r=["#fa4f04","#5edb02","#02d2b2","#6b03e1"];var n=null;var s={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/publishanalysis/collectTable",type:"get",xhrFields:{withCredentials:true},contentType:"application/json",data:function(t){a.gridPageFliter(t);var i=e.form.getParams($("#search-form"));if(!i.equipment)i.equipment="0";if(!i.resourceId)i.resourceId="0";if(i.startTime){i.endTime=i.startTime.slice(13);i.startTime=i.startTime.slice(0,10)}var r;if(i){r=$.extend({resType:"1",page:t.page,size:t.size},i)}return r}},columns:[{data:"collectTime",sWidth:"12.5%"},{data:"pubResourceNum",sWidth:"12.5%"},{data:"subEquipmentNum",sWidth:"12.5%"},{data:"extractValue",sWidth:"12.5%"},{data:"loadValue",sWidth:"12.5%"},{data:"extractCount",sWidth:"12.5%"},{data:"loadCount",sWidth:"12.5%"},{data:"extractTaskNum",sWidth:"12.5%"}],drawCallback:function(e){a.selectedTr($("#example1"))}};var l={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/publishanalysis/collectTable",type:"get",xhrFields:{withCredentials:true},contentType:"application/json",data:function(t){a.gridPageFliter(t);var i=e.form.getParams($("#search-form"));if(!i.equipment)i.equipment="0";if(!i.resourceId)i.resourceId="0";if(i.startTime){i.endTime=i.startTime.slice(13);i.startTime=i.startTime.slice(0,10)}var r;if(i){r=$.extend({resType:"2",page:t.page,size:t.size},i)}return r}},columns:[{data:"collectTime",sWidth:"16.6%"},{data:"pubResourceNum",sWidth:"16.6%"},{data:"subEquipmentNum",sWidth:"16.6%"},{data:"extractValue",sWidth:"16.6%"},{data:"loadValue",sWidth:"16.6%"},{data:"extractTaskNum",sWidth:"16.6%"}],drawCallback:function(e){a.selectedTr($("#example2"))}};var o={processing:true,serverSide:true,searching:false,ordering:false,lengthChange:false,pagingType:"full_numbers",ajax:{url:$.path+"/api/publishanalysis/collectTable",type:"get",xhrFields:{withCredentials:true},contentType:"application/json",data:function(t){a.gridPageFliter(t);var i=e.form.getParams($("#search-form"));if(!i.equipment)i.equipment="0";if(!i.resourceId)i.resourceId="0";if(i.startTime){i.endTime=i.startTime.slice(13);i.startTime=i.startTime.slice(0,10)}var r;if(i){r=$.extend({resType:"3",page:t.page,size:t.size},i)}return r}},columns:[{data:"collectTime",sWidth:"25%"},{data:"pubResourceNum",sWidth:"25%"},{data:"subEquipmentNum",sWidth:"25%"},{data:"extractTaskNum",sWidth:"25%"}],drawCallback:function(e){a.selectedTr($("#example3"))}};var u=function(t){if(!t||t=="1"){n=e.datatables({container:$("#example1"),option:s,filter:a.gridFilter})}else if(t=="2"){n=e.datatables({container:$("#example2"),option:l,filter:a.gridFilter})}else if(t=="3"){n=e.datatables({container:$("#example3"),option:o,filter:a.gridFilter})}};var c={color:i,legend:{left:"center",data:[]},tooltip:{trigger:"axis",axisPointer:{animation:false}},grid:{top:"20%",left:"5%",right:"5%",bottom:"10%",containLabel:true},xAxis:{type:"category",data:[]},yAxis:{type:"value",min:0,minInterval:1,boundaryGap:[0,0],splitLine:{show:true,lineStyle:{color:"#c0c0c0"}},axisLabel:{textStyle:{color:"#666"},formatter:function(e,a){return parseInt(e)}}},series:[{name:"流入",type:"line",hoverAnimation:false,smooth:true,areaStyle:{normal:{color:"#20a8d8",opacity:"0.2"}},data:[]}]};var d={color:["#2fb6e6","#faba3c","#67c2ef","#ff8e8e","#00acee"],tooltip:{trigger:"item",formatter:function(e){if(e.data.names.length>25){var a=[];for(var t=0;t<e.data.names.length;t++){if(t>=25&&t%25==0){a.push(e.data.names[t]+"<br />")}else{a.push(e.data.names[t])}}var i=a.join("");return e.seriesName+"<br />"+i+" ("+e.percent+"%)"}else{return e.seriesName+"<br />"+e.data.names+" ("+e.percent+"%)"}}},legend:{orient:"vertical",top:"middle",right:"18%",itemWidth:15,itemHeight:15,data:[]},series:[{name:"订阅设备",type:"pie",radius:["50%","70%"],avoidLabelOverlap:false,hoverAnimation:false,label:{normal:{show:true,position:"center",formatter:function(e,a,t,i){return e.seriesName}}},labelLine:{normal:{show:false}},center:["30%","50%"],data:[]}]};var p=function(a,i,r){var n={};n.chart=null;var s=e.form.getParams($("#search-form"));if(!s.equipment)s.equipment="0";if(!s.resourceId)s.resourceId="0";if(s.startTime){s.endTime=s.startTime.slice(13);s.startTime=s.startTime.slice(0,10)}var l=$.extend({lineChartType:r?r:"1",resType:a?a:"1"},s);n.draw=function(r){e.ajax({url:$.path+"/api/publishanalysis/lineChartData",type:"post",params:l,success:function(r){if(r&&r.data){var r=r.data;if(JSON.stringify(r)=="{}"){r=[{xvalue:"",yvalue:""}]}var s=[],l=[];r.forEach(function(e,a){s.push(e.xvalue);l.push(e.yvalue)});if(s.length==1){c.series[0].symbolSize=10}else{c.series[0].symbolSize=0}c.xAxis.data=s;c.series[0].data=l;var o;if(!a||a==1){o="发布资源数"}if(a==2){o="发布文件数"}if(a==3){o="发布API数"}c.series[0].name=i?i:o;n.chart=e.echarts({container:$("#chart1"),echarts:t,chartOption:c})}}})};n.draw(true)};var m=function(a,i){var r={};r.chart=null;var n=e.form.getParams($("#search-form"));if(n.startTime){n.endTime=n.startTime.slice(13);n.startTime=n.startTime.slice(0,10)}r.params={startTime:n.endTime,resType:a?a:"1"};r.draw=function(){e.ajax({url:$.path+"/api/publishanalysis/findExtractFlowEquipmentTop",type:"post",params:r.params,success:function(a){var a=a.data;if(JSON.stringify(a)=="{}"){a={"暂无订阅设备":0}}var i=[],n=[];for(var s in a){if(s&&s.indexOf("暂无")>-1){i.push(s);n.push({itemStyle:{normal:{color:"#d8d8d8"}},value:parseFloat(a[s]),name:s,names:s});d.color=["#d8d8d8"]}else{var l=s.slice(0,10);i.push(l);n.push({value:parseFloat(a[s]),name:l,names:s})}}d.legend.data=i;d.series[0].data=n;r.chart=e.echarts({container:$("#chart2"),chartOption:d,echarts:t})}})};r.draw()};var f=function(){e.form.date({element:$("#startTime"),range:true,dateOption:{max:-1}});$("#startTime").val(e.getDateByDay(-61,false)+" ~ "+e.getDateByDay(-1,false))};var h=function(a,t){var i={resType:a?a:"1"};if(t){i=$.extend(i,{equipment:t})}e.ajax({type:"post",url:$.path+"/api/publishanalysis/getResourceList",params:i,success:function(a){e.template({container:$(".sourceName"),templateId:"sourceName-tpl",data:a.data})}})};var v=function(a,t){var i={resType:a?a:"1",resourceId:t?t:"0"};e.ajax({type:"post",url:$.path+"/api/publishanalysis/getEquipmentList",params:i,success:function(a){e.template({container:$(".subDevice"),templateId:"subDevice-tpl",data:a.data})}})};var g=function(e,a){var t=[{key:"extractCount",label:"抽取记录数",type:"0",value:"3"},{key:"extractTaskNum",label:"任务执行次数",type:"0",value:"4"},{key:"extractValue",label:"抽取流量",type:"0",value:"2"},{key:"loadCount",label:"加载记录数",type:"0",value:"8"},{key:"loadValue",label:"加载流量",type:"0",value:"7"},{key:"pubResourceNum",label:"发布资源数",type:"0",value:"1"},{key:"subEquipmentNum",label:"订阅设备数",type:"0",value:""},{key:"appNum",label:"订阅应用数",type:"0",value:""}];if(e=="extractTaskNum"){if(a=="1")return{name:"任务执行次数",value:"4"};if(a=="2")return{name:"任务执行次数",value:"4"};if(a=="3")return{name:"调用次数",value:"6"}}if(e=="pubResourceNum"){if(a=="1")return{name:"发布资源数",value:"1"};if(a=="2")return{name:"发布文件数",value:"1"};if(a=="3")return{name:"发布API数",value:"1"}}for(var i=0;i<t.length;i++){if(t[i].key==e){return{name:t[i].label,value:t[i].value}}}};var y=function(a){var a=a?a:"1";var t=e.form.getParams($("#search-form"));if(!t.equipment)t.equipment="0";if(!t.resourceId)t.resourceId="0";if(t.startTime){t.endTime=t.startTime.slice(13);t.startTime=t.startTime.slice(0,10)}var i=$.extend({resType:a},t);e.ajax({type:"post",url:$.path+"/api/publishanalysis/publishAnalysis",params:i,contentType:"application/json",success:function(e){var e=e.data,t="",i="";$("#lineList").empty();for(var r in e){if(e[r]){var n=g(r,a);if(n.name!="订阅设备数"&&n.name!="订阅应用数"){i+="<option value='"+n.value+"'>"+n.name+"</option>"}var s;if(a=="1")s=100/7+"%";if(a=="2")s=100/5+"%";if(a=="3")s=100/4+"%";var l=a==1?'style="padding:0"':"";t+='<div style="width:'+s+'">'+'<div class="col-md-2"'+l+'><i class="fa fa-upload"></i></div>'+'<div class="col-md-10" style="padding:0">'+"<div>"+n.name+"</div>"+'<div class="num" style="font-size:22px;line-height:22px;">'+e[r]+"</div>"+"</div>"+"</div>"}}$("#lineList").append(i);$(".counter").html(t)}})};var b=function(){$("#search").on("click",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");a.search(n);p(e);m(e);y(e)})};var T=function(){var a=e.form.getParams($("#search-form"));if(!a.resourceId)a.resourceId="0";if(!a.equipment)a.equipment="0";if(a.startTime){a.endTime=a.startTime.slice(13);a.startTime=a.startTime.slice(0,10)}var t=$.extend(a,{resType:1,model:2});var i="";for(var r in t){i+=r+"="+t[r]+"&"}var n=i.substring(0,i.length-1);window.location.href=$.path+"/api/commonController/downloadAnalysis?"+n};function x(){e.scroll({container:$(".scrollWrapper")})}var k=function(){$(".ui-grid-buttonbar .import").on("click",function(){T()});$("#search-form .sourceName").on("change",function(){var e=$(this).val();var a=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");v(a,e)});$("#search-form .subDevice").on("change",function(){var e=$(this).val();var a=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");h(a,e)});$(".ui-grid-buttonbar .ui-grid-linkGroup li").on("click",function(){var e=$(this).attr("key");if(e=="1"){$("#fileContent").hide();$("#apiContent").hide();$("#dataContent").show()}else if(e=="2"){$("#dataContent").hide();$("#apiContent").hide();$("#fileContent").show()}else if(e=="3"){$("#dataContent").hide();$("#fileContent").hide();$("#apiContent").show()}h(e);v(e);y(e);p(e);m(e);u(e)});$("#lineList").on("change",function(){var e=$(".ui-grid-buttonbar .ui-grid-linkGroup li.active").attr("key");var a=$(this).val();var t=$(this).find("option:selected").text();p(e,t,a)})};var C=function(){$(".statisticalDate .showDate").html(": "+e.getDateByDay(-1,false))};return{main:function(){x();f();h();v();y();p();m();a.setPanelButtonbar();a.setGridLinkGroup();k();u();b();C()}}});